# 座標系について

## 座標系

ゲームオブジェクト空間とUI空間とでは座標系が異なる

### ゲームオブジェクト空間

座標系はグローバル座標と地形座標の２つの座標系が存在する。

グローバル座標はx軸は右を正、y軸は上を正とする座標系。
基本はグローバル座標であり、それぞれのプロパティからアクセスする事ができる。グローバル座標系を使いたい場合はglobal_から始まるものでアクセスする。

スケールと回転速度は地形座標とグローバル座標で同じ。地形座標系はグローバル座標系と同じく、上方向がYの正方向、右方向がXの正方向になるようにしなければならない。

速度については、地形座標系速度でもその長の尺度はグローバル座標系と同じものとして扱う。これにより地形座標系速度とグローバル座標系速度の変換がベクトルの回転のみで行えるようになる。
トランスフォーム内部では、地形座標系速度を地形座標系での長さに合わせて変換したものを地形座標に適用する。この操作を正規化、ベクトルを正規化された地形座標系速度と呼ぶことにする。

所属地形の情報保持はTransformが行う。
座標を変更した場合、回転度は変更した座標系のものが維持される。グローバルポジションをいじるときはグローバル回転度が維持される、地形ポジションが変更されるときは地形回転度が維持される。

### UI空間

x軸は右を正、y軸は下を正とする

## ゲームオブジェクトの親子関係と座標

ゲームオブジェクトのトランスフォームコンポーネントはグローバル座標とローカル座標を持つ。

通常はローカル座標を参照、変更し、衝突判定、描画処理ではグローバル座標を用いる。

グローバル座標はシステムプロセスでローカル座標と親から求められるので、変更しても次回更新時に変更は破棄される。

なので表示座標系の処理(ドット表示用に位置を整数値にする)などは、衝突判定プロセスと描画プロセスのあいだでプロセスを走らせれば、次のフレームでの位置変更に影響を与えない。

……それだと衝突判定の結果も反映されないんだけど……

ゲームオブジェクト更新後に速度適用とローカルグローバル変換、衝突判定後にグローバルローカル変換を行うようにシステムプロセスを追加した。グローバルローカル変換からローカルグローバル変換のあいだにグローバル座標に与える変更は反映されないので上記の方法は使える。

ローカル座標、グローバル座標が変更されたときに随時グローバル座標、ローカル座標をそれぞれ更新するようにした。パフォーマンスは下がるがわかりやすい。ローカル座標グローバル座標の不整合が発生しない。また、更新が必要ない場合は更新しないなどの最適化をしたい。

## 地形座標系について

WirePlanetに則って地形による座標系定義を導入。

### WirePlanetの方法

各オブジェクトは、所属地形でのローカル座標と、空間でのグローバル座標を持っている。所属地形は、独自の座標系を持ち(円形の閉じた座標系など)、地形オブジェクトの座標変換関数によってグローバル座標を求め、それを衝突判定や描画に用いた。

### 利点

通常とは異なる座標系(惑星上など)を通常の座標系と全く同じ感覚で扱える。

### 欠点

ローカル座標をグローバル座標に変換するが、グローバル座標を使う衝突判定前、描画前の二回行う必要がある。

座標の形によっては位置によってグローバル座標での移動速度か変わってしまう。惑星極座標でいうと、同じ分の座標移動でも、中心に近い場合と遠い場合では遠いほどグローバルな移動量は多くなる。

グローバル座標とローカル座標の整合性を保つためには、変更のたびに変換しないといけない。
地形の座標系によってはローカル座標系と表示画像の形状にずれが生じる
地形オブジェクトが持つべき関数が多い(ローカルグローバル座標変換関数、グローバルローカル座標変換関数、座標間隔の違いによらず速度を一定にするための関数、など)

### 今までの流れ

#### 時期不明1

地形座標は廃止するが、所属地形の概念は残す。所属地形は、座標によって下方向を示すベクトルを返す関数を持つ。これにより、惑星の重力も再現可能。

#### 時期不明2

上記方法でWirePlanetの方法を再現するのはかなりやりづらいので再導入する

#### 2016/5/31以前のいつか(現状)

しかし、３つの座標系が存在することになり複雑になりすぎるので、親子関係は廃止してローカル座標をなくす。位置の依存関係などはコンポーネントで補う。

## 座標系優先度について

地形座標とグローバル座標の優先度を決める必要がある。グローバル位置を変更したときに、回転度はそのままにするのか、地形座標に合わせて変えるのかなど。

### 今までの流れ

#### 2016/7/9(現状)

回転度はそのままにすることにした。グローバルポジションをいじるときはグローバル回転度が維持される、地形ポジションが変更されるときは地形回転度が維持されれば良い。
